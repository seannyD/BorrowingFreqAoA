---
title: "Age of acquisition and borrowing"
output: pdf_document
---

This analysis treats POS as a random effect.

TODO: why is freq and borrowing apparently positively correlated in the last graph?  Something's wrong with the predicted values from the model, or the linear model is not capturing the data well.
Need to add quadratic effect of frequency

TODO: scaling phon length should center on whole number.


```{r echo=F,eval=F}
setwd("~/Documents/MPI/MonaghanAoA/Stats 2/analysis/")
```


# Load libraries

```{r}
library(lme4)
library(sjPlot)
library(lattice)
library(ggplot2)
library(dplyr)
library(party)
logit2per = function(X){
  return(exp(X)/(1+exp(X)))
}
```

# Load data

1 = definately borrowed
5 = no evidence of borrowing

```{r}
dataloan <- read.csv("../analysis/loanword8.csv",stringsAsFactors = F)
dataloan$bor15 <- ifelse(dataloan$borrowing==1,1, ifelse(dataloan$borrowing==5,0,NA))
dataloan$bor15.cat <- factor(dataloan$bor15)
```

Convert to numbers and scale.

```{r}
dataloan$subtlexzipf = as.numeric(dataloan$subtlexzipf)
dataloan$AoA <- as.numeric(dataloan$AoA)

aoaSD = sd(dataloan$AoA,na.rm = T)
aoaMean = mean(dataloan$AoA/aoaSD,na.rm=T)

dataloan$AoAscale <- scale(as.numeric(dataloan$AoA))
dataloan$subtlexzipfscale <- scale(as.numeric(dataloan$subtlexzipf))
dataloan$phonlengthscale <-
  dataloan$phonlength - median(dataloan$phonlength)
dataloan$concscale <- scale(as.numeric(dataloan$conc))

dataloan$cat = factor(dataloan$cat)
dataloan$cat = relevel(dataloan$cat,"Noun")
```

Select only complete cases.

```{r}
dataloan2 = dataloan[complete.cases(dataloan[,
               c("phonlengthscale","AoAscale",
               "subtlexzipfscale", "cat",
               'concscale','bor15')]),]
```

# Overall patterns

```{r}
ctx = ctree(bor15.cat~cat+phonlengthscale+
        AoAscale + subtlexzipfscale+ concscale,
      dataloan2)
plot(ctx)
```



# Random effect structure

Baseline model.

```{r}
m0 = glmer(bor15.cat ~ 1 + (1 | cat),
           data=dataloan2, family = binomial)
```
Random slope for AoA

```{r}
m0.1 = glmer(bor15.cat ~ 1 + (1 | cat) + (0 + AoAscale|cat),
           data=dataloan2, 
           family = binomial)
anova(m0,m0.1)
```

Random slope for freq.
```{r}
m0.2 = glmer(bor15.cat ~ 1 + 
               (1 | cat) + 
               (0 + AoAscale|cat) + 
               (0 + subtlexzipfscale | cat),
             data=dataloan2, family = binomial)
anova(m0.1,m0.2)
```

Random slope for length.
```{r}
m0.3 = glmer(bor15.cat ~ 1 + 
               (1 | cat) + 
               (0 + AoAscale|cat) + 
               (0 + subtlexzipfscale | cat) + 
               (0 + phonlengthscale| cat),
             data=dataloan2, family = binomial)
anova(m0.2,m0.3)
```

Random slope for concreteness?
```{r}
m0.35 = glmer(bor15.cat ~ 1 + (1 | cat) + 
                (0 + AoAscale|cat) + 
                (0 + subtlexzipfscale | cat) + 
                (0 + phonlengthscale| cat) + 
                (0 + concscale | cat),
             data=dataloan2, family = binomial)
anova(m0.3,m0.35)
```

Not significant.

Check correlation parameters between random slopes
```{r}
m0.4 = glmer(bor15.cat ~ 1 + 
               (1 + AoAscale+ 
                  subtlexzipfscale + 
                  phonlengthscale| cat),
             data=dataloan2, family = binomial)
anova(m0.3,m0.4)
```

All are significant, but correlation parameters cause convergence issue and add lots of degrees of freedom.  We'll leave them out.  Anyway, as we see in the later analyses, the random slopes actually account for very little variation in the final models.

# Fixed effects

Main effect of length
```{r}
m1 = glmer(bor15.cat ~ 
             phonlengthscale + 
             (1 | cat) + 
             (0 + AoAscale|cat) + 
             (0 + subtlexzipfscale | cat) + 
             (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial)
m1.5 = glmer(bor15.cat ~ 
             phonlengthscale + 
             I(phonlengthscale^2) +
             (1 | cat) + 
             (0 + AoAscale|cat) + 
             (0 + subtlexzipfscale | cat) + 
             (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial)
```
Main effect of aoa and quadratic term.
```{r}
m2 = glmer(bor15.cat ~ 
             phonlengthscale + 
             AoAscale + 
             (1 | cat) + 
             (0 + AoAscale|cat) +
             (0 + subtlexzipfscale | cat) + 
             (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial)
m2.5 = glmer(bor15.cat ~ 
             phonlengthscale + 
             AoAscale + 
             I(AoAscale^2) +
             (1 | cat) + 
             (0 + AoAscale|cat) +
             (0 + subtlexzipfscale | cat) + 
             (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial)
```
Main effect of freq
```{r}
m3 = glmer(bor15.cat ~ phonlengthscale + 
             AoAscale + 
             subtlexzipfscale  + 
             (1 | cat) + 
             (0 + AoAscale|cat) + 
             (0 + subtlexzipfscale | cat) + 
             (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial)
m3.5 = glmer(bor15.cat ~ phonlengthscale + 
             AoAscale + 
             subtlexzipfscale  + 
             I(subtlexzipfscale^2)  + 
             (1 | cat) + 
             (0 + AoAscale|cat) + 
             (0 + subtlexzipfscale | cat) + 
             (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial)

```

Test significance by model comparison:

```{r}
anova(m0.3,m1,m1.5)
anova(m1,m2)
anova(m2,m2.5)
anova(m2,m3,m3.5)
```

... all are significant (but not quadratic effect of AoA nor quadratic effect of length).

Main effect of concreteness
```{r}
m3.6 = glmer(bor15.cat ~ 
               phonlengthscale + 
               AoAscale + 
               subtlexzipfscale + 
               I(subtlexzipfscale^2)  +
               concscale + 
               (1 | cat) + 
               (0 + AoAscale|cat) + 
               (0 + subtlexzipfscale | cat) + 
               (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial)
anova(m3.5,m3.6)
```
... not significant

Interaction between AoA and freq.
```{r}
m4 = glmer(bor15.cat ~ phonlengthscale +
             AoAscale*subtlexzipfscale  + 
             I(subtlexzipfscale^2)  +
             (1 | cat) + 
             (0 + AoAscale|cat) + 
             (0 + subtlexzipfscale | cat) + 
             (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial,
           control = glmerControl(optimizer = "bobyqa"))
anova(m3.5,m4)
```

... not significant.

Interaction between AoA and length:
```{r}
m5 = glmer(bor15.cat ~ 
             phonlengthscale*AoAscale +
             subtlexzipfscale+
             I(subtlexzipfscale^2)  +
             (1 | cat) +
             (0 + AoAscale|cat) + 
             (0 + subtlexzipfscale | cat) + 
             (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial,
           control = glmerControl(optimizer = "bobyqa"))
anova(m3.5,m5)
```

Not significant.

Interaction between length and freq.

```{r}
m6 = glmer(bor15.cat ~ 
             phonlengthscale +
             AoAscale+subtlexzipfscale  + 
             I(subtlexzipfscale^2)  +
             subtlexzipfscale:phonlengthscale + 
             (1 | cat) + 
             (0 + AoAscale|cat) + 
             (0 + subtlexzipfscale | cat) +
             (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial,
           control = glmerControl(optimizer = "bobyqa"))
anova(m3.5,m6)
```

Not significant.

# Sumamry

The best model is model 3.5 with all main effects and quadratic effect of frequency.

Summary of coefficients:
```{r}
summary(m3.5)
```

Plot fixed effects and random effects:
```{r}
sjp.glmer(m3.5, 'fe')
sjp.glmer(m3.5, 'eff')
dotplot(ranef(m3.5))
```

Main random effects are for the general level of borrowing prob., very little difference for slopes.

Check the effect of random intercept with the full model:
```{r}
m3.5.nointercept = glmer(bor15.cat ~ 
                         phonlengthscale + 
             AoAscale + 
             subtlexzipfscale  + 
             I(subtlexzipfscale^2)  +
                         (0 + AoAscale|cat) + 
                         (0 + subtlexzipfscale | cat) +
                         (0 + phonlengthscale| cat),
           data=dataloan2, family = binomial)
anova(m3.5,m3.5.nointercept)
```
... significant: different POS vary in their baseline probability of being borrowed.


Check the effects of random slopes with the full model (i.e. do the strength of the main effects vary by POS?):

```{r}
m3.5.noAoASlope = glmer(bor15.cat ~ 
                         phonlengthscale + 
             AoAscale + 
             subtlexzipfscale  + 
             I(subtlexzipfscale^2)  +
                        (1 | cat) +
                        (0 + subtlexzipfscale | cat) +
                        (0 + phonlengthscale| cat),
                           data=dataloan2, family = binomial)
anova(m3.5, m3.5.noAoASlope )

m3.5.nofreqSlope = glmer(bor15.cat ~ 
                         phonlengthscale + 
             AoAscale + 
             subtlexzipfscale  + 
             I(subtlexzipfscale^2)  +
                         (1 | cat) +
                         (0 + AoAscale | cat) + 
                         (0 + phonlengthscale| cat),
                      data=dataloan2, family = binomial,
                      control = glmerControl(optimizer = 'bobyqa'))
anova(m3.5, m3.5.nofreqSlope )

m3.5.nolengthSlope = glmer(bor15.cat ~ 
                         phonlengthscale + 
             AoAscale + 
             subtlexzipfscale  + 
             I(subtlexzipfscale^2)  +
                           (1 | cat) + 
                           (0 + AoAscale | cat) + 
                           (0 + subtlexzipfscale| cat),
                       data=dataloan2, family = binomial)
anova(m4, m3.5.nolengthSlope )
```

... random slopes do not improve the fit of the model over the fixed effects.  So strength does not vary by POS.


# Plots

Raw data

```{r}
dataloan2$Borrowed = c("Not borrowed", "Borrowed")[dataloan2$bor15+1]
ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(x=AoA, colour=Borrowed)) +
  geom_density()

ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(x=as.numeric(subtlexzipfscale), colour=Borrowed)) +
  geom_density()
  
ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(x=as.numeric(subtlexzipf), y=bor15)) +
  stat_smooth()+
  xlab("Frequency")



ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(x=as.numeric(phonlength), y=bor15)) +
  stat_smooth() +
  xlab("Length")
  

dataloan2$subtlexzipf.cat = cut(
  dataloan2$subtlexzipf, 
  breaks = quantile(dataloan2$subtlexzipf,
                    prob=seq(0,1,length.out=4)),
  include.lowest = T)


#dataloan2[!is.na(dataloan2$AoA) & !is.na(dataloan2$subtlexzipf) & !is.na(dataloan2$bor15.catLabel),] %>% group_by(bor15.catLabel, subtlexzipf.cat) %>% summarise(mean=mean(AoA))


ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(y=AoA, colour=Borrowed, x=subtlexzipf.cat)) +
  geom_boxplot()

ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(y=AoA, colour=Borrowed, x=cat)) +
  geom_boxplot()

ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(y=as.numeric(subtlexzipfscale), colour=Borrowed, x=cat)) +
  geom_boxplot()


```


Model predictions:  plot the interaction between frequency and age of acquisition.

```{r}
aoarange = range(dataloan2$AoAscale)

pd = data.frame(
  AoAscale = seq(aoarange[1],aoarange[2], length.out = 100),
  subtlexzipfscale = 0,
  concscale = 0,
  phonlengthscale = 0)

# scale some ages
year3 = (3/aoaSD) -aoaMean
year6 = (6/aoaSD) - aoaMean
year9 = (9/aoaSD) -aoaMean

pd$subtlexzipfscale = year6
predMed = logit2per(predict(m4,pd, re.form=NA))
pd$subtlexzipfscale = year3
predLow = logit2per(predict(m4,pd, re.form=NA))
pd$subtlexzipfscale = year9
predHigh = logit2per(predict(m4,pd, re.form=NA))

pd$AoA = (pd$AoAscale + aoaMean) * aoaSD

plot(pd$AoA, predMed, type='l', ylim=c(0,1),
     xlab='Age of acquisition',
     ylab = "Probability of borrowing",
     las=1)
title(ylab='XXX',srt=90)
points(pd$AoA, predLow, type='l', col='blue')
points(pd$AoA, predHigh, type='l', col='red')


#effects::effect("subtlexzipfscale",m4)

# Use effect to predict values for prob borrowing for 
#  3 age groups
intdf  = data.frame(
  effects::effect("AoAscale:subtlexzipfscale",m4, xlevels=list(AoAscale=c(year3,year6,year9), subtlexzipfscale=seq(aoarange[1],aoarange[2], length.out = 100))))
#colnames(intdf) <- c("grp", "x", "y", "se", "conf.low", 
#                "conf.high")
intdf$AoAscale = factor(intdf$AoAscale)

baseplot <- ggplot(intdf,
                   aes_string(x = "subtlexzipfscale", y = "fit", 
            colour = "AoAscale"))
baseplot <- baseplot + 
  geom_ribbon(
    aes_string(
      ymin = "lower", 
      ymax = "upper", 
      colour = NULL, 
      fill = "AoAscale"), 
    alpha = 0.3, 
    show.legend = FALSE) +
  geom_line(size = 2) +
  scale_color_discrete(breaks=c(year9,year6,year3),
                       labels=c("9y","6y",'3y'),
                       name="AoA") +
  xlab("Frequency (log, scaled)") + 
  ylab("Probability of borrowing")

baseplot


```


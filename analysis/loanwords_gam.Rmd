---
title: "Cognitive influences in language evolution: English data"
output: pdf_document
---

# Introduction

This is the model code for Monaghan & Roberts, "Cognitive influences in language evolution: Psycholinguistic predictors of loan word borrowing".  It takes data from the WOLD database of borrowing for English and tries to predict whether a word has been borrowed or not according to various psycholinguitic measures.

The main fields in the data frame are:

-  word: Orthographic form
-  borrowing: variable from WOLD indicating level of evidence for borrowing:
  -  1 = definately borrowed
  -  5 = no evidence of borrowing
-  age_oldest, age_youngest: Dates from WOLD indicating estiamte of data of entry into English
-  phonology:  Phonological form
-  phonlength:  Number of segments in the phonological form
-  AoA: Age of acquisition ratings from Kuperman, Stadthagen-Gonzalez, and Brysbaert (2012).
-  AoA_obj: Objective, test-based age of acuqisition from Brysbaert & Biemiller (2017)
-  subtlexzipf:  Log frequency of word from the SUBTLEX database
-  conc:  Concreteness ratings from Brysbaert, Warriner, & Kuperman (2014)
-  cat: Dominant part of speech according to SUBTLEX.
-  bor15:  Conversion of the WOLD borrowing variable into a numeric (0 = not borrowed, 1 = borrowed)


```{r echo=F,eval=F}
setwd("~/Documents/MPI/MonaghanAoA/Stats 2/analysis/")
```


# Load libraries

```{r warning=F, message=F}
library(mgcv)
library(sjPlot)
library(lattice)
library(ggplot2)
library(dplyr)
library(party)
library(lmtest)
library(gridExtra)
library(scales)
library(itsadug)
library(ggfortify)
library(factoextra)
library(gridExtra)
library(reshape2)

logit2per = function(X){
  return(exp(X)/(1+exp(X)))
}

rescaleGam = function(px, n, xvar, xlab=""){
  y = logit2per(px[[n]]$fit)
  x = px[[n]]$x *attr(xvar,"scaled:scale") + attr(xvar,"scaled:center")
  se.upper = logit2per(px[[n]]$fit+px[[n]]$se)
  se.lower = logit2per(px[[n]]$fit-px[[n]]$se)
  dx = data.frame(x=x,y=y,ci.upper=se.upper,ci.lower=se.lower)
  plen = ggplot(dx, aes(x=x,y=y))+
    geom_ribbon(aes(ymin=ci.lower,ymax=ci.upper), alpha=0.3)+
    geom_line(size=1) +
    xlab(xlab)+
    ylab("Probability of borrowing")+
    coord_cartesian(ylim = c(0,1))
  return(plen)
}

```

# Load data

```{r}
dataloan <- read.csv("../data/loanword8.csv",stringsAsFactors = F)
dataloan$bor15 <- ifelse(dataloan$borrowing==1,1, ifelse(dataloan$borrowing==5,0,NA))
dataloan$bor15.cat <- factor(dataloan$bor15)
```

Convert to numbers.

```{r warning=F}
dataloan$subtlexzipf = as.numeric(dataloan$subtlexzipf)
dataloan$AoA = as.numeric(dataloan$AoA)
dataloan$conc = as.numeric(dataloan$conc)

aoaSD = sd(dataloan$AoA,na.rm = T)
aoaMean = mean(dataloan$AoA/aoaSD,na.rm=T)
dataloan$cat = factor(dataloan$cat)
```

Select only complete cases.

```{r}
dataloan2 = dataloan[complete.cases(dataloan[,
               c("phonlength","AoA",
               "subtlexzipf", "cat",
               'conc','bor15')]),]
```

Scale and center:

```{r}
dataloan2$AoAscale <- scale(dataloan2$AoA)

dataloan2$subtlexzipfscale <- scale(dataloan2$subtlexzipf)

phonlength.center = median(dataloan2$phonlength)
dataloan2$phonlengthscale <-
  dataloan2$phonlength - phonlength.center
phonlength.scale = sd(dataloan2$phonlengthscale)
dataloan2$phonlengthscale = dataloan2$phonlengthscale/phonlength.scale

attr(dataloan2$phonlengthscale,"scaled:scale") = phonlength.scale
attr(dataloan2$phonlengthscale,"scaled:center") = phonlength.center

dataloan2$concscale <- scale(dataloan2$conc)

dataloan2$cat = relevel(dataloan2$cat,"Noun")

dataloan2$AoA_objscaled = scale(dataloan2$AoA_obj)
```


Identify Swadesh words:

```{r}
swd = read.csv("../data/SwadeshConcepts.txt", header = F, stringsAsFactors = F)$V1
dataloan2$Swadesh = dataloan2$word %in% swd
```


\newpage

# Plots

Raw data

```{r}
dataloan2$Borrowed = c("Not borrowed", "Borrowed")[dataloan2$bor15+1]
ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(x=AoA, colour=Borrowed)) +
  geom_density()

ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(x=as.numeric(subtlexzipfscale), colour=Borrowed)) +
  geom_density()
  
ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(x=as.numeric(subtlexzipf), y=bor15)) +
  stat_smooth()+
  xlab("Frequency")

ggplot(dataloan2[!is.na(dataloan2$Borrowed),], aes(x=as.numeric(phonlength), y=bor15)) +
  stat_smooth() +
  xlab("Length")
  
dataloan2$subtlexzipf.cat = cut(
  dataloan2$subtlexzipf, 
  breaks = quantile(dataloan2$subtlexzipf,
                    prob=seq(0,1,length.out=4)),
  include.lowest = T)

```

Look at variation between parts of speech:

```{r}
catx = data.frame(
  PoS = tapply(dataloan2$cat, dataloan2$cat, function(X){as.character(X[1])}),
  mean = tapply(dataloan2$bor15, dataloan2$cat, mean),
  n = tapply(dataloan2$bor15, dataloan2$cat, length)
)
catx = catx[order(catx$mean, decreasing = T),]
catx$PoS = factor(catx$PoS, levels = catx[order(catx$mean, decreasing = T),]$PoS)

posg = ggplot(catx, aes(x=mean, y=PoS)) +
  geom_point(size=2) + 
  ylab("Part of speech") +
  xlab("Proportion of words borrowed")+
  scale_x_continuous(labels=percent_format()) +
  geom_text(aes(label=n), nudge_y=0.4)

pdf("../results/graphs/POS_Borrowing.pdf",
    width = 6,
    height = 4)
posg
dev.off()

catx$mean= catx$mean*100
write.csv(catx, "../results/English_POS_BorrowingProportions.csv", row.names = F)

```


\newpage

# GAM 

```{r}
m0 = bam(bor15.cat ~
      s(phonlengthscale) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re'),
    data = dataloan2,
    family='binomial')
```

```{r}
summary(m0)
```


## Interactions

Test whether an interaction between AoA and frequency is warranted using likelihood ratio comparisons:

```{r}
m1 = bam(bor15.cat ~
      s(phonlengthscale) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re') +
      te(AoAscale,subtlexzipfscale),
    data = dataloan2,
    family='binomial')

lrtest(m0,m1)
```

No significant improvement.

Test whether an interaction between AoA and length is warranted:

```{r}
m2 = bam(bor15.cat ~
      s(phonlengthscale) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re') +
      te(AoAscale,phonlengthscale),
    data = dataloan2,
    family='binomial')

lrtest(m0,m2)
```

No significant improvement.

Test whether an interaction between Frequency and length is warranted:

```{r}
m3 = bam(bor15.cat ~
      s(phonlengthscale) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re') +
      te(subtlexzipfscale,phonlengthscale),
    data = dataloan2,
    family='binomial')

lrtest(m0,m3)
```

No significant improvement.

So no interactions are necessary.

\newpage

# Model plots

Plot the model estimates, changing the dependent scale to probability and the independent variables to their original scales.  The code uses the `itsadug` package and then rescales the variables back to the original units.  This code is hidden, but you can view it in the Rmd file.

```{r echo=F}
# Old code for plotting model estimates without taking
# random effects into account
px = plot.gam(m0,select=1, xlab="Word length", ylab="Log odds of borrowing",shade = T)
y = logit2per(px[[1]]$fit)
x = px[[1]]$x *phonlength.scale + phonlength.center
se.upper = logit2per(px[[1]]$fit+px[[1]]$se)
se.lower = logit2per(px[[1]]$fit-px[[1]]$se)
dx = data.frame(x=x,y=y,ci.upper=se.upper,ci.lower=se.lower)
plen = ggplot(dx, aes(x=x,y=y))+
  geom_ribbon(aes(ymin=ci.lower,ymax=ci.upper), alpha=0.3)+
  geom_line(size=1) +
  xlab("Word Length")+
  ylab("Probability of borrowing")+
  coord_cartesian(ylim = c(0,1))

#Age of acquisition, Frequency and Concreteness.

paoa = rescaleGam(px,2,dataloan2$AoAscale, "Age of acquisition")
pfreq = rescaleGam(px,3,dataloan2$subtlexzipfscale, "Frequency")
pconc = rescaleGam(px,4,dataloan2$concscale, "Concreteness")
pconc
grid.arrange(plen,pfreq,paoa, nrow=1)
pdf(file='../results/graphs/English_ModelResults.pdf',
    height =3,width = 8)
grid.arrange(plen,pfreq,paoa, nrow=1)
dev.off()
```

We can also plot the effects when removing the random effects (using the library `itsadug`).  These are essentially the same, though not as easy to understand.

```{r echo=F}
# from itsadug: plot ignoring random effects
px = plot_smooth(m0,view="subtlexzipfscale", rm.ranef = T, print.summary=F)
px$fv$fit = logit2per(px$fv$fit)
px$fv$ul = logit2per(px$fv$ul)
px$fv$ll = logit2per(px$fv$ll)
px$fv$subtlexzipfscale = px$fv$subtlexzipfscale * attr(dataloan2$subtlexzipfscale,"scaled:scale") + attr(dataloan2$subtlexzipfscale,"scaled:center")

gFreq = ggplot(px$fv, aes(x=subtlexzipfscale,y=fit)) + 
  geom_ribbon(aes(ymin=ll,ymax=ul), alpha=0.3) +
  geom_line(size=1) +
  ylab("Probability of borrowing") +
  xlab("Frequency") +
  coord_cartesian(ylim=c(0,1))

px = plot_smooth(m0,view="AoAscale", rm.ranef = T, print.summary=F)
px$fv$fit = logit2per(px$fv$fit)
px$fv$ul = logit2per(px$fv$ul)
px$fv$ll = logit2per(px$fv$ll)
px$fv$AoAscale = px$fv$AoAscale * attr(dataloan2$AoAscale,"scaled:scale") + attr(dataloan2$AoAscale,"scaled:center")

gAoA = ggplot(px$fv, aes(x=AoAscale,y=fit)) + 
  geom_ribbon(aes(ymin=ll,ymax=ul), alpha=0.3) +
  geom_line(size=1) +
  ylab("Probability of borrowing") +
  xlab("Age of acquisition")+
  coord_cartesian(ylim=c(0,1))

px = plot_smooth(m0,view="phonlengthscale", rm.ranef = T, print.summary = F)
px$fv$fit = logit2per(px$fv$fit)
px$fv$ul = logit2per(px$fv$ul)
px$fv$ll = logit2per(px$fv$ll)
px$fv$phonlengthscale = px$fv$phonlengthscale * phonlength.scale + phonlength.center

gLen = ggplot(px$fv, aes(x=phonlengthscale,y=fit)) + 
  geom_ribbon(aes(ymin=ll,ymax=ul), alpha=0.3) +
  geom_line(size=1) +
  ylab("Probability of borrowing") +
  xlab("Word length")+
  coord_cartesian(ylim=c(0,1))

grid.arrange(gLen, gFreq, gAoA, nrow=1)
pdf("../results/graphs/English_ModelResults_NoRF.pdf",
    height =3,width = 8)
grid.arrange(gLen, gFreq, gAoA, nrow=1)
dev.off()
```


\newpage

# Objective measures of AoA

Below we run the same model, but with objective, test-based AoA from Brysbaert et al. (2017).  Note that the values for objective AoA are only whole numbers, so there are not as many unique values and we have to limit the number of knots that the model uses.

```{r}
m0.obj = bam(bor15.cat ~
      s(phonlengthscale) + 
      s(AoA_objscaled, k=3) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoA_objscaled,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re'),
    data = dataloan2[!is.na(dataloan2$AoA_objscaled),],
    family='binomial')
```

```{r}
summary(m0.obj)
```

Very similar results.  For example, almost all coefficients are the same:

```{r}
plot(m0.obj$coefficients, m0$coefficients[names(m0.obj$coefficients)])
```

The outlier is the coefficient for `subtlexzipfscale`.

And chi squared terms are similar:

```{r}
m0S = summary(m0)
m0.objS = summary(m0.obj)
cbind(m0=m0S$chi.sq,m0.obj=m0.objS$chi.sq)[1:4,]
```

## Objective AoA: Model plots

Visualise the model smooth terms, independent of influence of random effects. The code is hidden, but you can view it in the Rmd file.

```{r echo=F}
# from itsadug: plot ignoring random effects
px = plot_smooth(m0.obj,view="subtlexzipfscale", 
                 rm.ranef = T,print.summary=F)
px$fv$fit = logit2per(px$fv$fit)
px$fv$ul = logit2per(px$fv$ul)
px$fv$ll = logit2per(px$fv$ll)
px$fv$subtlexzipfscale = px$fv$subtlexzipfscale * attr(dataloan2$subtlexzipfscale,"scaled:scale") + attr(dataloan2$subtlexzipfscale,"scaled:center")

gFreqO = ggplot(px$fv, aes(x=subtlexzipfscale,y=fit)) + 
  geom_ribbon(aes(ymin=ll,ymax=ul), alpha=0.3) +
  geom_line(size=1) +
  ylab("Probability of borrowing") +
  xlab("Frequency") +
  coord_cartesian(ylim=c(0,1))

px = plot_smooth(m0.obj,view="AoA_objscaled", rm.ranef = T, print.summary=F)
px$fv$fit = logit2per(px$fv$fit)
px$fv$ul = logit2per(px$fv$ul)
px$fv$ll = logit2per(px$fv$ll)
px$fv$AoA_objscaled = px$fv$AoA_objscaled * attr(dataloan2$AoA_objscaled,"scaled:scale") + attr(dataloan2$AoA_objscaled,"scaled:center")

gAoAO = ggplot(px$fv, aes(x=AoA_objscaled,y=fit)) + 
  geom_ribbon(aes(ymin=ll,ymax=ul), alpha=0.3) +
  geom_line(size=1) +
  ylab("Probability of borrowing") +
  xlab("Age of acquisition (objective)")+
  coord_cartesian(ylim=c(0,1))

px = plot_smooth(m0.obj,view="phonlengthscale", rm.ranef = T, print.summary=F)
px$fv$fit = logit2per(px$fv$fit)
px$fv$ul = logit2per(px$fv$ul)
px$fv$ll = logit2per(px$fv$ll)
px$fv$phonlengthscale = px$fv$phonlengthscale * phonlength.scale + phonlength.center

gLenO = ggplot(px$fv, aes(x=phonlengthscale,y=fit)) + 
  geom_ribbon(aes(ymin=ll,ymax=ul), alpha=0.3) +
  geom_line(size=1) +
  ylab("Probability of borrowing") +
  xlab("Word length")+
  coord_cartesian(ylim=c(0,1))

grid.arrange(gLenO, gFreqO, gAoAO, nrow=1)
pdf("../results/graphs/English_ModelResults_ObjectiveAoA_NoRF.pdf",
    height =3,width = 8)
grid.arrange(gLenO, gFreqO, gAoAO, nrow=1)
dev.off()
  
```


```{r echo=F, eval=F}
# Old code for making graphs without controlling for random effects
pxobj = plot.gam(m0.obj,select=1, xlab="Word length", ylab="Log odds of borrowing",shade = T)

y = logit2per(pxobj[[1]]$fit)
x = pxobj[[1]]$x *phonlength.scale + phonlength.center
se.upper = logit2per(pxobj[[1]]$fit+pxobj[[1]]$se)
se.lower = logit2per(pxobj[[1]]$fit-pxobj[[1]]$se)
dx = data.frame(x=x,y=y,ci.upper=se.upper,ci.lower=se.lower)
plenobj = ggplot(dx, aes(x=x,y=y))+
  geom_ribbon(aes(ymin=ci.lower,ymax=ci.upper), alpha=0.3)+
  geom_line(size=1) +
  xlab("Word Length")+
  ylab("Probability of borrowing")+
  coord_cartesian(ylim = c(0,1))
paoaobj = rescaleGam(pxobj,2,dataloan2$AoAscale, "Age of acquisition")
pfreqobj = rescaleGam(pxobj,3,dataloan2$subtlexzipfscale, "Frequency")
pconcobj = rescaleGam(pxobj,4,dataloan2$concscale, "Concreteness")
pconcobj
grid.arrange(plenobj,pfreqobj,paoaobj, nrow=1)
```


# Distribution of words

Match up words with presence or absence in Swedesh list

```{r}
dx = dataloan2[,      c("subtlexzipf",
                        "AoA",
                        "phonlength",
                        "conc",
                        "Swadesh"),]
names(dx) = c("Frequency","AoA","Length","Concreteness","Swadesh")
dx$Swadesh = c("No","Yes")[1+as.numeric(dx$Swadesh)]
dx = dx[complete.cases(dx),]

```

Plot the distributions (code hidden but available in the Rmd file):

```{r echo=F}
dFreq = ggplot(dx,aes(Frequency, fill=Swadesh)) +
  geom_density(alpha=0.6) + theme_minimal() +
  scale_fill_manual(values = c(gray(0.1),gray(0.8))) +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid = element_blank(),
        legend.position = 'none',
        plot.margin=unit(c(1,0.1,0.2,0.1),"cm"))
dAoA = ggplot(dx,aes(AoA, fill=Swadesh)) +
  geom_density(alpha=0.6) + theme_minimal() +
  scale_fill_manual(values = c(gray(0.2),gray(0.8))) +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid = element_blank(),
        legend.position = 'none')
dLen = ggplot(dx,aes(Length, fill=Swadesh)) +
  geom_density(bw=1,alpha=0.6) + theme_minimal() +
  scale_fill_manual(values = c(gray(0.2),gray(0.8)),
                    breaks = c("Yes","No"),
                    labels = c("Swadesh list words","Wider lexicon")) +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        legend.position = 'top')
dConc = ggplot(dx,aes(Concreteness, fill=Swadesh)) +
  geom_density(alpha=0.6) + theme_minimal() +
  scale_fill_manual(values = c(gray(0.2),gray(0.8))) +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid = element_blank(),
        legend.position = 'none')

grid.arrange(dLen,dFreq,dAoA,dConc, nrow=2) 
pdf("../results/graphs/English_Distribution.pdf",
    width= 5.5, height = 4)
grid.arrange(dLen,dFreq,dAoA,dConc, nrow=2) 
dev.off()
```



Try a PCA plot:

```{r}

dx = dataloan2[,      c("subtlexzipfscale",
                        "AoAscale",
                        "phonlengthscale",
                        "concscale",
                        "Swadesh"),]
names(dx) = c("Frequency","AoA","Length","Conc.","Swadesh")
dx$Swadesh = c("No","Yes")[1+as.numeric(dx$Swadesh)]
dx = dx[complete.cases(dx),]

pc = prcomp(dx[, 1:4])

gpc1 = autoplot(pc, data = dx, colour = 'Swadesh',
         loadings = TRUE, loadings.colour = 'black', loadings.label.colour='black',
         loadings.label = TRUE, loadings.label.size = 5,frame = TRUE, frame.type = 'norm') +
  theme(legend.position = 'none')

gpc2 = autoplot(pc, data = dx, x = 1,y = 3,
         colour = 'Swadesh',
         loadings = TRUE, loadings.colour = 'black', loadings.label.colour='black',
         loadings.label = TRUE, loadings.label.size = 5,frame = TRUE, frame.type = 'norm') 
gxpc123 = grid.arrange(gpc1, gpc2, nrow=1, widths=c(0.8,1))
plot(gxpc123)
pdf("../results/graphs/English_Swadesh_PCA.pdf",
    width = 10, height= 4.5)
plot(gxpc123)
dev.off()
```



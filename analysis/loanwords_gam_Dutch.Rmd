---
title: "Age of acquisition and borrowing: Dutch"
output: pdf_document
---


```{r echo=F,eval=F}
setwd("~/Documents/MPI/MonaghanAoA/Stats 2/analysis/")
```


# Load libraries

```{r warning=F, message=F}
library(mgcv)
library(sjPlot)
library(lattice)
library(ggplot2)
library(gplots)
library(dplyr)
library(party)
library(lmtest)
library(gridExtra)
library(itsadug)
library(car)
library(caret)
library(scales)


logit2per = function(X){
  return(exp(X)/(1+exp(X)))
}

rescaleGam = function(px, n, xvar, xlab=""){
  y = logit2per(px[[n]]$fit)
  x = px[[n]]$x *attr(xvar,"scaled:scale") + attr(xvar,"scaled:center")
  se.upper = logit2per(px[[n]]$fit+px[[n]]$se)
  se.lower = logit2per(px[[n]]$fit-px[[n]]$se)
  dx = data.frame(x=x,y=y,ci.upper=se.upper,ci.lower=se.lower)
  plen = ggplot(dx, aes(x=x,y=y))+
    geom_ribbon(aes(ymin=ci.lower,ymax=ci.upper), alpha=0.3)+
    geom_line(size=1) +
    xlab(xlab)+
    ylab("Probability of borrowing")+
    coord_cartesian(ylim = c(0,1))
  return(plen)
}
```

# Load data

```{r}
load("../data/loanwords_Dutch.Rdat")
load("../data/loanwords_Japanese.Rdat")
load("../data/loanwords_French.Rdat")
```

# Part of speech

```{r}
catx = data.frame(
  PoS = tapply(dutch$cat, dutch$cat, function(X){as.character(X[1])}),
  mean = tapply(dutch$bor15, dutch$cat, mean),
  n = tapply(dutch$bor15, dutch$cat, length)
)
catx = catx[order(catx$mean, decreasing = T),]
catx$PoS = factor(catx$PoS, levels = catx[order(catx$mean, decreasing = T),]$PoS)

posg = ggplot(catx, aes(x=mean, y=PoS)) +
  geom_point(size=2) + 
  ylab("Part of speech") +
  xlab("Proportion of words borrowed")+
  scale_x_continuous(labels=percent_format()) +
  geom_text(aes(label=n), nudge_y=0.4)

pdf("../results/graphs/POS_Borrowing_Dutch.pdf",
    width = 6,
    height = 4)
posg
dev.off()

catx$mean= catx$mean*100
write.csv(catx, "../results/Dutch_POS_BorrowingProportions.csv", row.names = F)

```


# GAM model

Dutch data has `r nrow(dutch)` datapoints.

The range of the length variable limits the number of knots that the gam model can fit:

```{r}
m0.dutch = bam(bor15.cat ~
      s(phonlengthscale, k=3) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re'),
    data = dutch,
    family='binomial')
```

```{r}
summary(m0.dutch)
```

\newpage

## Interactions

Test whether an interaction between AoA and frequency is warranted:

```{r}
m1.dutch = bam(bor15.cat ~
      s(phonlengthscale, k=3) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re') +
      te(AoAscale,subtlexzipfscale),
    data = dutch,
    family='binomial')

lrtest(m0.dutch,m1.dutch)
```

No significant improvement.

Test whether an interaction between AoA and length is warranted:

```{r}
m2.dutch = bam(bor15.cat ~
      s(phonlengthscale, k=3) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re') +
      te(AoAscale,phonlengthscale),
    data = dutch,
    family='binomial')

lrtest(m0.dutch,m2.dutch)
```

There is no improvement in log likelihood.

Test whether an interaction between Frequency and length is warranted:

```{r}
m3.dutch = bam(bor15.cat ~
      s(phonlengthscale, k=3) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re') +
      te(subtlexzipfscale,phonlengthscale),
    data = dutch,
    family='binomial')

lrtest(m0.dutch,m3.dutch)
```

No significant improvement.

So no interactions are necessary.


## Model estiamtes

Plot the model estimates, changing the dependent scale to probability and the independent variables to their original scales.

```{r}

px = plot.gam(m0.dutch,select=1, xlab="Word length", ylab="Log odds of borrowing",shade = T)

plen = rescaleGam(px, 1, dutch$phonlengthscale,"Word length") + ggtitle("Dutch")
paoa = rescaleGam(px, 2, dutch$AoAscale,"Age of acquisition") + ggtitle("")
pfreq = rescaleGam(px, 3, dutch$AoAscale,"Frequency") + ggtitle("")
pconc = rescaleGam(px, 4, dutch$concscale,"Concreteness") + ggtitle("Dutch")

pconc

grid.arrange(plen,pfreq,paoa, nrow=1)
pdf(file='../results/graphs/Dutch_ModelResults.pdf',
    height =3,width = 8)
grid.arrange(plen,pfreq,paoa, nrow=1)
dev.off()
```

# Predicting date of entry

The dates of entry for Dutch are much more dispersed than for English, so we transform them further using the Box-Cox method:

```{r}
# remove non-borrowed words
dutch[dutch$bor15!=1,]$age.oldest.num = NA
# Take log years
dutch$age.oldest.num.scaled = log10(dutch$age.oldest.num)
# scale with boxcox
pp = preProcess(dutch[,c('age.oldest.num.scaled','AoAscale')], method="BoxCox")
dutch$age.oldest.num.scaled = bcPower(dutch$age.oldest.num.scaled, lambda = pp$bc$age.oldest.num.scaled$lambda)
dutch$age.oldest.num.scaled = scale(dutch$age.oldest.num.scaled)
```

Plot raw data

```{r warning=F}
hist(dutch[dutch$bor15==1,]$age.oldest.num.scaled)

g.ageAoA = ggplot(dutch[dutch$bor15==1,], 
      aes(x=as.numeric(AoAscale), y=age.oldest.num))+
         geom_smooth() +
  scale_y_reverse(lim=c(1000,250))


g.ageLen = ggplot(dutch[dutch$bor15==1,], 
  aes(x=length, y=age.oldest.num))+
         geom_smooth()+
  scale_y_reverse(lim=c(1000,250))

g.ageFreq = ggplot(dutch[dutch$bor15==1,],
  aes(x=as.numeric(subtlexzipfscale), y=age.oldest.num))+
         geom_smooth()+
  scale_y_reverse(lim=c(1000,250))

grid.arrange(g.ageLen,g.ageFreq,g.ageAoA, nrow=1)
```

GAM model:  Because there are fewer datapoints, we build up the mode one variable at a time, keeping the variable if it significantly improves the fit of the model.

```{r}
m0.age = bam(age.oldest.num.scaled~
    1 +
    s(cat,bs='re')+
    s(cat,phonlengthscale,bs='re')+
    s(cat,AoAscale,bs='re')+
    s(cat,subtlexzipfscale,bs='re'),
    data = dutch[dutch$bor15==1,])
m1.age = update(m0.age, ~.+ s(AoAscale))
lrtest(m0.age,m1.age)
# Significant
m2.age = update(m1.age, ~.+ s(phonlengthscale, k=3))
lrtest(m1.age,m2.age)
# Not significant
m3.age = update(m1.age, ~.+ s(subtlexzipfscale))
lrtest(m1.age,m3.age)
# Not significant
m4.age = update(m1.age, ~.+ s(concscale))
lrtest(m1.age,m4.age)
# Not sigificant
```

Final model has just age of acquisition as a main effect, so let's take away the random effects for other variables:

```{r}
m5.age = bam(age.oldest.num.scaled~
    s(AoAscale) +
    s(cat,bs='re') +
    s(cat,AoAscale,bs='re'),
    data = dutch[dutch$bor15==1,])
summary(m5.age)
```


Plot the model estimates.  The code is hidden, but you can view it in the Rmd file.  Note that the estimates actually come from different models.  Only the age of acuqisition result is relevant to the main results in the paper, but the others are shown for illustration.

```{r echo=F}
rescaleDate = function(X){
  10^(X * attr(dutch$age.oldest.num.scaled,'scaled:scale') +
  attr(dutch$age.oldest.num.scaled,'scaled:center'))
}

rescaleDateGraph = function(model,var,lab){
  px = plot_smooth(model,view=var, rm.ranef = T,
                   print.summary=F)
  px$fv$fit = rescaleDate(px$fv$fit) 
  px$fv$ul = rescaleDate(px$fv$ul) 
  px$fv$ll = rescaleDate(px$fv$ll) 
  
  px$fv[,var] = px$fv[,var] * attr(dutch[,var],"scaled:scale") + attr(dutch[,var],"scaled:center")
  
  gx = ggplot(px$fv, aes_string(x=var,y="fit")) + 
    geom_ribbon(aes(ymin=ll,ymax=ul), alpha=0.3) +
    geom_line(size=1) +
    ylab("Date of borrowing (years before 2000)") +
    xlab(lab) +
    coord_cartesian(ylim=c(0,6000))+
    scale_y_reverse()
    
 return(gx) 
}

gAoAA = rescaleDateGraph(m5.age, "AoAscale","Age of acquisition")+
  ggtitle("")
gFreqA = rescaleDateGraph(m3.age,"subtlexzipfscale","Frequency")+
  ggtitle("")
gLenA = rescaleDateGraph(m2.age,"phonlengthscale","Word Length") +
  ggtitle("Dutch")

grid.arrange(gLenA, gFreqA, gAoAA, nrow=1)
pdf("../results/graphs/Dutch_ModelResults_AgeOfBorrowing_NoRF.pdf",
    height =3,width = 8)
grid.arrange(gLenA, gFreqA, gAoAA, nrow=1)
dev.off()

pdf("../results/graphs/Dutch_ModelResults_AgeOfBorrowing_NoRF_AoA.pdf",
    height =3,width = 8/3)
gAoAA + ggtitle("Dutch")
dev.off()

```


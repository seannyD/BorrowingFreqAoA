---
title: "Cognitive influences in language evolution: Dutch data"
output: pdf_document
---

# Introduction

This is the model code for Monaghan & Roberts, "Cognitive influences in language evolution: Psycholinguistic predictors of loan word borrowing".  It takes data from the WOLD database of borrowing for Dutch and tries to predict whether a word has been borrowed or not according to various psycholinguitic measures.

```{r echo=F,eval=F}
setwd("~/Documents/MPI/MonaghanAoA/Stats 2/analysis/")
```


# Load libraries

```{r warning=F, message=F}
library(mgcv)
library(sjPlot)
library(lattice)
library(ggplot2)
library(gplots)
library(dplyr)
library(party)
library(lmtest)
library(gridExtra)
library(itsadug)
library(car)
library(caret)
library(scales)


logit2per = function(X){
  return(exp(X)/(1+exp(X)))
}

rescaleGam = function(px, n, xvar, xlab=""){
  y = logit2per(px[[n]]$fit)
  x = px[[n]]$x *attr(xvar,"scaled:scale") + attr(xvar,"scaled:center")
  se.upper = logit2per(px[[n]]$fit+px[[n]]$se)
  se.lower = logit2per(px[[n]]$fit-px[[n]]$se)
  dx = data.frame(x=x,y=y,ci.upper=se.upper,ci.lower=se.lower)
  plen = ggplot(dx, aes(x=x,y=y))+
    geom_ribbon(aes(ymin=ci.lower,ymax=ci.upper), alpha=0.3)+
    geom_line(size=1) +
    xlab(xlab)+
    ylab("Probability of borrowing")+
    coord_cartesian(ylim = c(0,1))
  return(plen)
}
```

# Load data

The Dutch data is processed very similarly to the English data.  The full process can be found in the `processing` folder, but here we just load the final prepared data frame:

```{r}
load("../data/loanwords_Dutch.Rdat")
```

# Part of speech

```{r}
catx = data.frame(
  PoS = tapply(dutch$cat, dutch$cat, function(X){as.character(X[1])}),
  mean = tapply(dutch$bor15, dutch$cat, mean),
  n = tapply(dutch$bor15, dutch$cat, length)
)
catx = catx[order(catx$mean, decreasing = T),]
catx$PoS = factor(catx$PoS, levels = catx[order(catx$mean, decreasing = T),]$PoS)

posg = ggplot(catx, aes(x=mean, y=PoS)) +
  geom_point(size=2) + 
  ylab("Part of speech") +
  xlab("Proportion of words borrowed")+
  scale_x_continuous(labels=percent_format()) +
  geom_text(aes(label=n), nudge_y=0.4)

pdf("../results/graphs/POS_Borrowing_Dutch.pdf",
    width = 6,
    height = 4)
posg
dev.off()

catx$mean= catx$mean*100
write.csv(catx, "../results/Dutch_POS_BorrowingProportions.csv", row.names = F)

```


# GAM model

Dutch data has `r nrow(dutch)` datapoints.

The range of the length variable limits the number of knots that the gam model can fit:

```{r}
m0.dutch = bam(bor15.cat ~
      s(phonlengthscale, k=3) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re'),
    data = dutch,
    family='binomial')
```

```{r}
summary(m0.dutch)
```

\newpage

## Interactions

Test whether an interaction between AoA and frequency is warranted:

```{r}
m1.dutch = bam(bor15.cat ~
      s(phonlengthscale, k=3) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re') +
      te(AoAscale,subtlexzipfscale),
    data = dutch,
    family='binomial')

lrtest(m0.dutch,m1.dutch)
```

No significant improvement.

Test whether an interaction between AoA and length is warranted:

```{r}
m2.dutch = bam(bor15.cat ~
      s(phonlengthscale, k=3) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re') +
      te(AoAscale,phonlengthscale),
    data = dutch,
    family='binomial')

lrtest(m0.dutch,m2.dutch)
```

There is no improvement in log likelihood.

Test whether an interaction between Frequency and length is warranted:

```{r}
m3.dutch = bam(bor15.cat ~
      s(phonlengthscale, k=3) + 
      s(AoAscale) + 
      s(subtlexzipfscale) +
      s(concscale) +
      s(cat,bs='re')+
      s(cat,phonlengthscale,bs='re')+
      s(cat,AoAscale,bs='re')+
      s(cat,subtlexzipfscale,bs='re')+
      s(cat,concscale,bs='re') +
      te(subtlexzipfscale,phonlengthscale),
    data = dutch,
    family='binomial')

lrtest(m0.dutch,m3.dutch)
```

No significant improvement.

So no interactions are necessary.


## Model estiamtes

Plot the model estimates, changing the dependent scale to probability and the independent variables to their original scales (code is hidden, but available in the Rmd file).

```{r echo=F}
px = plot.gam(m0.dutch,select=1, xlab="Word length", ylab="Log odds of borrowing",shade = T)

plen = rescaleGam(px, 1, dutch$phonlengthscale,"Word length") + ggtitle("Dutch")
paoa = rescaleGam(px, 2, dutch$AoAscale,"Age of acquisition") + ggtitle("")
pfreq = rescaleGam(px, 3, dutch$AoAscale,"Frequency") + ggtitle("")
pconc = rescaleGam(px, 4, dutch$concscale,"Concreteness") + ggtitle("Dutch")

pconc

grid.arrange(plen,pfreq,paoa, nrow=1)
pdf(file='../results/graphs/Dutch_ModelResults.pdf',
    height =3,width = 8)
grid.arrange(plen,pfreq,paoa, nrow=1)
dev.off()
```

Plot the model estimates, removing the influence of the random effects using the library `itsadug` (code is hidden, but available in the Rmd file).

```{r echo=F}
getSmoothPlot = function(model, view, label){
  px = plot_smooth(model,view=view, 
                   rm.ranef = T,print.summary=F)
  px$fv$fit = logit2per(px$fv$fit)
  px$fv$ul = logit2per(px$fv$ul)
  px$fv$ll = logit2per(px$fv$ll)
  px$fv[,view] = px$fv[,view] * attr(dutch[,view],"scaled:scale") + attr(dutch[,view],"scaled:center")
  
  ggplot(px$fv, aes_string(x=view,y="fit")) + 
    geom_ribbon(aes(ymin=ll,ymax=ul), alpha=0.3) +
    geom_line(size=1) +
    ylab("Probability of borrowing") +
    xlab(label) +
    coord_cartesian(ylim=c(0,0.6))
}

pfreq =getSmoothPlot(m0.dutch,"subtlexzipfscale","Frequency")
plen =getSmoothPlot(m0.dutch,"phonlengthscale","Word Length")
paoa =getSmoothPlot(m0.dutch,"AoAscale","Age of acquisition")
pconc =getSmoothPlot(m0.dutch,"concscale","Concreteness")
pconc

grid.arrange(plen,pfreq,paoa, nrow=1)
pdf("../results/graphs/Dutch_ModelResults_NoRF.pdf",
    height =3,width = 8)
grid.arrange(plen,pfreq,paoa, nrow=1)
dev.off()
```


Random effects for Part of speech

```{r}
mc = m0.dutch$coefficients
mc[grepl("s\\(cat\\)",names(mc))]

raw = tapply(dutch$bor15,dutch$cat,mean)
model.est = logit2per(m0.dutch$coefficients[1] +
              mc[grepl("s\\(cat\\)",names(mc))])

plot(raw, model.est,
  xlab="Raw proportions",
  ylab="Model estimates",
  col="white",
     ylim=c(0,0.3),
     xlim=c(0,0.3))  
abline(0,1,col='gray')
text(raw, model.est, names(raw))
```


